# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:

- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:

- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/styles/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск

Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```

## Сборка

```
npm run build
```

или

```
yarn build
```

## Данные и типы данных,используемые в приложении

```
Тип описывающий категории товара

export type CategoryType =
 | 'другое'
 | 'софт-скил'
 | 'дополнительное'
 | 'кнопка'
 | 'хард-скил';

```
```
Карточка

export interface ICard {
id: string;
description: string;
image: string;
title: string;
category: CategoryType;
price: number | null;
selected: boolean;
}

```
```
Заказ

export interface IOrder extends IOrderData {
  items: string[],
  total: number,
}

```
```
Корзина с товарами

export interface IAppState {
catalog: ICard[];
preview: string;
basket: string;
order: IOrder;
total: string | number;
loading: boolean;
}

```

```
Данные по заказу

export interface IOrderData {
	payment: string;
	address: string;
	email: string;
	phone: string;
}

```

```
Тип возвращения результата с сервера

export interface IOrderResult {
id: string;
total: number;
}

```

```
Тип описывающий ошибки валидации форм

export type FormErrors = Partial<Record<keyof IOrder, string>>;

```

## Архитектура приложения

Код приложения разделен на слои согласно парадигме MVP.

Данный подход позволяет создавать абстракцию представления. Для этого необходимо выделить интерфейс представления с определенным набором свойств и методов. Презентер, в свою очередь, получает ссылку на реализацию интерфейса, подписывается на события представления и по запросу изменяет модель.

- слой представления, отвечает за отображение данных на странице;
- слой данных, отвечает за хранение данных;
- презентер,отвечает за связь представления и данных.

### Базовый код

#### Класс API

Содержит в себе базовую логику отправки запросов.
В конструктор передается базовый адрес сервера и опциональный объект с заголовками запросов.
Методы: -`get` - выполняет запрос на переданной в параметрах ендпоинт и возвращает промис с объектом,которым ответил сервер. -`post`- принимает объект с данными,которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределен заданием третьего параметра при вызове.

#### Класс EventEmitter

Реализует паттерн «Наблюдатель» и позволяет подписываться на события и уведомлять подписчиков
о наступлении события.
Класс имеет методы on , off , emit — для подписки на событие, отписки от события и уведомления
подписчиков о наступлении события соответственно.
Дополнительно реализованы методы onAll и offAll — для подписки на все события и сброса всех
подписчиков.
Интересным дополнением является метод trigger , генерирующий заданное событие с заданными
аргументами. Это позволяет передавать его в качестве обработчика события в другие классы. Эти
классы будут генерировать события, не будучи при этом напрямую зависимыми от
класса EventEmitter .

#### Класс Component<T>

Абстрактные класс дженерик, обобщающий в себе конструктор и основные методы работы с компонентами отображения.

Конструктор:
принимает на вход container типа HTMLElement
Методы:

toggleClass — метод переключения класса элемента
setDisabled — метод блокировки кнопки
setText- метод установки текста
setImage — метод установки изображения элемента и его alt
render — метод слияния входящих данных и отрисовки элемента

## Слой данных

#### Класс CardsData

Класс отвечает за логику работы с данными карточек.\
Конструктор класса принимает инстант брокера событий.\
В полях класса хранятся следующие данные:
-\_cards:ICard[]- массив объектов карточек
-\_preview:string|null- id карточки, выбранной для просмотра.

#### Класс IOrderData

Класс отвечает за хранение и логику работы с данными пользователя.\
Конструктор класса принимает инстант брокера событий.\
В полях класса хранятся следующие данные:
-payment: string - Выбор способа оплаты заказа
-adress:string - Адрес доставки
-email: string - Электронная почта пользователя
-phone: string - Телефон пользователя

### Классы представления

Все классы представления отвечают за отображение внутри контейнера (DOM-элемент)
передаваемых в них данных.

#### Класс Modal

Реализует модальное окно. Также представляет методы `open` и `close` для управления отображения модального окна.
Устанавливает слушатели на клик в оверлей и на кнопку крестик для закрытия попапа.
-constructor(selector:string, events:IEvents) Конструктор принимает селектор, по которому в разметке страницы будет идентифицировано модальное окно и экземпляр класса `EventEmmiter` для возможности инициаций событий.

Поля класса
-modal: HTMLElement-элемент модального окна
-events:IEvents-брокер событий

### Класс ModalWithConfirm

Расширяет класс Modal. Предназначен для реализации модального окна подтверждения. При открытии модального окна сохраняет полученный в параметрах обработчик,который передается для выполнения при сабмите формы.\
Поля класса
-submitButton: HTMLButtonElement-Кнопка подтверждения
-\_form: HTMLFormElement-Элемент формы
-\_formName: string - значение атрибута name формы
-\_handleSubmit: Function- функция, на выполнение которой запрашивается подтверждение.
Методы:
-setValid(isValid:boolean):void-изменяет активность кнопки подтверждения
-open(handleSubmit: Function):void-расширение родительского метода, принимает обработчик,который передается при инициации события подтверждения
-get form-HTMLElement-геттер для получения элемента формы

### Класс ModalWithForm

Расширяет класс Modal. Предназначен для реализации модального окна с формой содержащей поле ввода. При сабмите инициирует событие передавая в него объект с данными из полей ввода формы. Предоставляет методы для управления активности кнопки сохранения.\
Поля класса:
-submitButton:HTMLElement-Кнопка подтверждения
\_form: HTMLFormElement-Элемент формы
\_formName: string - значение атрибута name формы
Методы:
-setValid(isValid:boolean):void-изменяет активность кнопки подтверждения
-getInputValues(): Record<string,string>-возвращает объект с данными из полей формы,где ключ-name инпута,а значение-данные введенные пользователем

#### Класс Card

Отвечает за отображение карточки,задавая карточке данные названия, изображения,цены.
Класс используется для отображения карточек на странице сайта.
Поля класса содержат элементы разметки элементов карточек.Конструктор принимает экземпляр `EventEmitter` для инициации событий.
Методы:
-геттер id-уникальный id карточки

#### Класс CardsContainer

Отображает за изображение блока с карточками на главной странице. В конструктор принимает контейнер, в котором размещаются карточки.

#### Класс OrderInfo

Отвечает за блок сайта с информацией о заказе.
Конструктор принимает имя блока, родительский элемент и обработчик событий.

### Слой коммуникации

## Класс AppState

Принимает в конструктор экземпляр класса Api и представляет методы реализующие взаимодействие с бекэндом сервиса.
Класс, описывающий состояние приложения

export class AppState extends Model<IAppState> {
catalog: Product[];
preview: string;
basket: Product[]=[];
order: IOrder = {
items: [],
payment: '',
total: null,
address: '',
email: '',
phone: '',
};
// Объект с ошибками форм
formErrors: FormErrors = {};
// Метод для добавления товара в корзину
addToBasket(value: Product) {
this.basket.push(value);
}
// Метод для удаления товара из корзины
deleteFromBasket(id: string) {
this.basket = this.basket.filter(item => item.id !== id)
}
// Метод для полной очистки корзины
clearBasket() {
this.basket.length = 0;
}
// Метод для получения количества товаров в корзине
getBasketTotal() {
return this.basket.length;
}
// Метод для добавления ID товаров в корзине в поле items для order
setItems() {
this.order.items = this.basket.map(item =>item.id)
}
// Метод для заполнения полей email, phone, address, payment в order
setOrderField(field: keyof IOrderData, value: string) {
this.order[field] = value;

      if (this.validateContacts()) {
        this.events.emit('contacts:ready', this.order)
      }

      if (this.validateOrder()) {
          this.events.emit('order:ready', this.order);
      }

}
// Валидация форм для окошка "заказ"
validateOrder() {
const errors: typeof this.formErrors = {};
if (!this.order.address) {
errors.address = 'Необходимо указать адрес';
}
if (!this.order.payment) {
errors.payment = 'Необходимо указать способ оплаты';
}
this.formErrors = errors;
this.events.emit('formErrors:change', this.formErrors);
return Object.keys(errors).length === 0;
}
// Валидация форм для окошка "контакты"
validateContacts() {
const errors: typeof this.formErrors = {};
if (!this.order.email) {
errors.email = 'Необходимо указать email';
}
if (!this.order.phone) {
errors.phone = 'Необходимо указать телефон';
}

this.formErrors = errors;
this.events.emit('formErrors:change', this.formErrors);
return Object.keys(errors).length === 0;
}
// Очистить order после покупки товаров
refreshOrder() {
this.order = {
items: [],
total: null,
address: '',
email: '',
phone: '',
payment: ''
};
}
// Метод для получения суммы цены всех товаров в корзине
getTotal() {
return this.basket.reduce((sum, next) => sum + next.price, 0);
}
// Метод для превращения данных, полученых с сервера в тип данных приложения
setCatalog (items: ICard[]){
this.catalog = items.map(item => new Product(item, this.events));
this.emitChanges('items:changed', { catalog: this.catalog });
}
// Метод для обновления поля selected во всех товарах после совершения покупки
resetSelected() {
this.catalog.forEach(item => item.selected = false)
}

}

## Взаимодействие компонентов

Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`.\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

/_
Инициируется при изменении списка товаров и вызывает перерисовку
списка товаров на странице
_/
'items:changed'

/_
Инициируется при клике на карточку товара в классе StoreItem и приводит
к открытию модального окна с подробным описанием товара
_/
'card:select'

/_
Инициируется при клике на кнопку "В корзину" на карточке StoreItemPreview
В AppState добавляет товар в корзину, обновляет счётчик на корзине
в классе Page
Делает поле selected на товаре true для отключения кнопки, чтобы больше
товар добавить было нельзя
_/
'card:toBasket'

/_
Инициируется при клике на кнопку "корзина" и открывает модальное окно
с классом Basket, где отображаются товары добавленные в корзину
_/
'basket:open'

/_
Инициируется при клике на кнопку удаления товара в корзине
Удаляет товар из массива basket в классе AppData
Обновляет счётчик корзины на странице
Обновляет поле selected на товаре, делая его false
Обновляет сумму заказа в корзине
Обвновляет порядковые номера в списке корзины
_/
'basket:delete'

/_
Инициируется при клике на кнопку "Оформить" в корзине
Открывает окно с формой для заполнения адреса и способа оплаты
Используемый класс Order
_/
'basket:order'

/_
Инициируется при нажатии на кнопку "Далее" на стадии заполнения адреса и
способа оплаты в окошке Order
_/
'order:submit'

/_
Инициируется при нажатии на кнопку "Оплатить" на стадии заполнения телефона
и электронной почты в окошке Contacts
_/
'contacts:submit'

/_
Инициируется при вводе данных в форму заказа Order и контактов Contacts
Начинает процесс валидации формы
_/
'orderInput:change'

/_
Инициируется при вводе данных в форму окошка Order и совершает
процесс валидации формы, возвращает ошибки формы
_/
'orderFormErrors:change'

/_
Инициируется при вводе данных в форму окошка Contacts и совершает
процесс валидации формы, возвращает ошибки формы
_/
'contactsFormErrors:change'

/_
Инициируется при успешном ответе сервера при оплате товара
Открывает модальное окно сообщающее об успешной оплате
_/
'order:success'

/_
Инициируется при клике на кнопку закрытия модального окна
или при клике на свободное место вокруг модального окна
_/
'modal:close'
